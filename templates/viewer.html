<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>PDF Viewer</title>
  <style>
    body { margin: 0; background:#e9e9e9; font-family: system-ui, Arial, sans-serif; }
    #page-wrap { position: relative; width: max-content; margin: 16px auto; }
    .page { position: relative; margin: 16px auto; box-shadow: 0 2px 12px rgba(0,0,0,0.15); }
    canvas { display: block; }

  .hl {
    position: absolute;
    pointer-events: none;
    background: rgba(50, 205, 50, 0.35); 
    box-shadow: 0 0 8px 2px rgba(50, 205, 50, 0.6); 
  }


    .toolbar { position: sticky; top:0; background:#fff; padding:8px 12px; border-bottom:1px solid #ddd; z-index:10; }

    #loading-warning {
      position: fixed;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 165, 0, 0.9);
      color: #000;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 1000;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      transition: opacity 0.6s ease, transform 0.6s ease;
      text-align: center;
    }
  </style>
</head>
<body>

  <div id="loading-warning">
    ⚠️ Please stay on this tab until PDF is fully loaded
  </div>

  <div class="toolbar" id="toolbar">Loading PDF…</div>
  <div id="page-wrap"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    const PDF_URL = "{{ pdf_url }}";
    const container = document.getElementById("page-wrap");
    const toolbar = document.getElementById("toolbar");
    const warning = document.getElementById("loading-warning");
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

    let pdfDoc = null;
    const pageViews = {};
    let currentHighlight = null; 

   
    const SCALE = 0.8;

    async function renderAllPages() {
      const loadingTask = pdfjsLib.getDocument(PDF_URL);
      pdfDoc = await loadingTask.promise;
      toolbar.textContent = `PDF Loaded (${pdfDoc.numPages} pages)`;

      for (let i = 1; i <= pdfDoc.numPages; i++) {
        const page = await pdfDoc.getPage(i);
        const viewport = page.getViewport({ scale: SCALE });

        const pageDiv = document.createElement("div");
        pageDiv.className = "page";
        pageDiv.style.width = viewport.width + "px";
        pageDiv.style.height = viewport.height + "px";
        container.appendChild(pageDiv);

        
        const scaleFactor = window.devicePixelRatio || 2; 
        const canvas = document.createElement("canvas");
        canvas.width = viewport.width * scaleFactor;
        canvas.height = viewport.height * scaleFactor;
        canvas.style.width = viewport.width + "px";
        canvas.style.height = viewport.height + "px";
        pageDiv.appendChild(canvas);

        await page.render({
          canvasContext: canvas.getContext("2d"),
          viewport: page.getViewport({ scale: SCALE * scaleFactor })
        }).promise;

        pageViews[i] = { pageDiv, viewport };

        await new Promise(r => setTimeout(r, 10));
      }

      if (warning) {
        warning.style.opacity = "0";
        warning.style.transform = "translateX(-50%) translateY(-10px)"; 
        setTimeout(() => { warning.style.display = "none"; }, 600);
      }

      if (window.opener) window.opener.postMessage("pdf_ready", "*");
    }

    function applyHighlight(msg) {
      const page = parseInt(msg.page);
      if (!pageViews[page]) return;

      const { pageDiv, viewport } = pageViews[page];
      const x0 = parseFloat(msg.x0);
      const y0 = parseFloat(msg.y0);
      const x1 = parseFloat(msg.x1);
      const y1 = parseFloat(msg.y1);

      const pageHeightPts = viewport.height / viewport.scale;
      const T = viewport.transform;

      const A_pdf = [x0, pageHeightPts - y0];
      const B_pdf = [x1, pageHeightPts - y1];
      const A_vp = pdfjsLib.Util.applyTransform(A_pdf, T);
      const B_vp = pdfjsLib.Util.applyTransform(B_pdf, T);

      const left = Math.min(A_vp[0], B_vp[0]);
      const top = Math.min(A_vp[1], B_vp[1]);
      const width = Math.abs(B_vp[0] - A_vp[0]);
      const height = Math.abs(B_vp[1] - A_vp[1]);

      if (currentHighlight) {
        currentHighlight.remove();
        currentHighlight = null;
      }

      const hl = document.createElement("div");
      hl.className = "hl";
      hl.style.left = left + "px";
      hl.style.top = top + "px";
      hl.style.width = width + "px";
      hl.style.height = height + "px";
      pageDiv.appendChild(hl);

      currentHighlight = hl;

      hl.scrollIntoView({ behavior: "instant", block: "center", inline: "center" });
    }

    window.addEventListener("message", e => {
      const msg = e.data;
      if (msg && msg.page) applyHighlight(msg);
    });

    renderAllPages();
  </script>
</body>
</html>
